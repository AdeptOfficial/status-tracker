{% extends "base.html" %}

{% block title %}History - Status Tracker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with stats -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold">Request History</h1>
            <p class="text-gray-400">{{ requests|length }} completed request{% if requests|length != 1 %}s{% endif %}</p>
        </div>

        <!-- Right side: filters and sync button -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <!-- Filter by user (if users exist) -->
            {% if users %}
            <div class="flex items-center gap-2">
                <label for="user-filter" class="text-sm text-gray-400">Filter by user:</label>
                <select id="user-filter"
                        onchange="applyFilters()"
                        class="bg-gray-800 border border-gray-700 text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All users</option>
                    {% for user in users %}
                        <option value="{{ user }}" {% if current_user_filter == user %}selected{% endif %}>{{ user }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Library Sync button (admin only) -->
            {% if is_admin %}
            <button id="sync-library-btn"
                    onclick="showSyncModal()"
                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Sync Library
            </button>
            {% endif %}
        </div>
    </div>

    <!-- State filter tabs -->
    <div class="flex items-center gap-2 border-b border-gray-700 pb-2">
        <a href="/history"
           class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors
                  {% if not current_state_filter %}bg-gray-700 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
            All
        </a>
        <a href="/history?state=available"
           class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors
                  {% if current_state_filter == 'available' %}bg-green-700 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
            Available ({{ stats.available or 0 }})
        </a>
        <a href="/history?state=failed"
           class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors
                  {% if current_state_filter == 'failed' %}bg-red-700 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
            Failed ({{ stats.failed or 0 }})
        </a>
        <a href="/history?state=timeout"
           class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors
                  {% if current_state_filter == 'timeout' %}bg-gray-600 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
            Timeout ({{ stats.timeout or 0 }})
        </a>
    </div>

    <!-- Stats summary -->
    <div class="grid grid-cols-3 gap-4">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-500/20 rounded-lg">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.available or 0 }}</p>
                    <p class="text-sm text-gray-400">Available</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-red-500/20 rounded-lg">
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.failed or 0 }}</p>
                    <p class="text-sm text-gray-400">Failed</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gray-500/20 rounded-lg">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.timeout or 0 }}</p>
                    <p class="text-sm text-gray-400">Timed Out</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk select controls (admin only, only on Available tab) -->
    {% if is_admin and current_state_filter == 'available' and requests %}
    <div class="flex items-center justify-between bg-gray-800 rounded-lg border border-gray-700 p-3">
        <div class="flex items-center gap-3">
            <input type="checkbox" id="select-all"
                   onchange="toggleSelectAll()"
                   class="w-4 h-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-2">
            <label for="select-all" class="text-sm text-gray-300">Select All</label>
            <span id="selected-count" class="text-sm text-gray-500">(0 selected)</span>
        </div>
        <button id="bulk-delete-btn"
                onclick="showBulkDeleteModal()"
                class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors">
            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Selected
        </button>
    </div>
    {% endif %}

    <!-- Request cards -->
    <div id="history-content" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {% if requests %}
            {% for req in requests %}
                <div class="relative">
                    <!-- Checkbox overlay (admin only, Available tab only) -->
                    {% if is_admin and current_state_filter == 'available' %}
                    <div class="absolute top-2 left-2 z-10">
                        <input type="checkbox" class="item-checkbox w-5 h-5 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-2"
                               data-request-id="{{ req.id }}"
                               data-title="{{ req.title }}"
                               onchange="updateSelectionCount()">
                    </div>
                    {% endif %}
                    {% set request = req %}
                    {% include "components/card.html" %}
                </div>
            {% endfor %}
        {% else %}
            <div class="col-span-full text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-300">No history yet</h3>
                <p class="mt-1 text-gray-500">Completed requests will appear here.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Library Sync Modal (admin only) -->
{% if is_admin %}
<div id="sync-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/70" onclick="hideSyncModal()"></div>

    <!-- Modal content -->
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg border border-gray-700 max-w-md w-full p-6 relative">
            <!-- Initial state -->
            <div id="sync-initial">
                <h3 class="text-xl font-bold text-white mb-4">Sync Library</h3>

                <p class="text-gray-300 mb-4">
                    Import existing media from Jellyfin to the status dashboard.
                    This will create entries for all available content not yet tracked.
                </p>

                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 mb-6">
                    <p class="text-sm text-blue-300">
                        <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Jellyfin library will be rescanned first to ensure fresh data.
                    </p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button onclick="hideSyncModal()"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button onclick="startSync()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                        Start Sync
                    </button>
                </div>
            </div>

            <!-- Loading state -->
            <div id="sync-loading" class="hidden">
                <div class="text-center py-8">
                    <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-lg font-medium text-white mb-2">Syncing Library...</p>
                    <p class="text-sm text-gray-400">Scanning Jellyfin, Radarr, and Sonarr</p>
                </div>
            </div>

            <!-- Results state -->
            <div id="sync-results" class="hidden">
                <h3 class="text-xl font-bold text-white mb-4">Sync Complete</h3>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                        <span class="text-gray-300">Total Scanned</span>
                        <span id="sync-total" class="font-bold text-white">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-900/30 rounded-lg">
                        <span class="text-green-300">Added</span>
                        <span id="sync-added" class="font-bold text-green-400">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-blue-900/30 rounded-lg">
                        <span class="text-blue-300">Updated (filled missing IDs)</span>
                        <span id="sync-updated" class="font-bold text-blue-400">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                        <span class="text-gray-300">Skipped (already tracked)</span>
                        <span id="sync-skipped" class="font-bold text-gray-400">0</span>
                    </div>
                    <div id="sync-errors-row" class="hidden flex justify-between items-center p-3 bg-red-900/30 rounded-lg">
                        <span class="text-red-300">Errors</span>
                        <span id="sync-errors" class="font-bold text-red-400">0</span>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeSyncAndRefresh()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                        Done
                    </button>
                </div>
            </div>

            <!-- Error state -->
            <div id="sync-error" class="hidden">
                <h3 class="text-xl font-bold text-red-400 mb-4">Sync Failed</h3>
                <p id="sync-error-message" class="text-gray-300 mb-6"></p>
                <div class="flex justify-end">
                    <button onclick="hideSyncModal()"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Bulk Delete Confirmation Modal (admin only) -->
{% if is_admin %}
<div id="bulk-delete-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/70" onclick="hideBulkDeleteModal()"></div>

    <!-- Modal content -->
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg border border-gray-700 max-w-md w-full p-6 relative">
            <h3 class="text-xl font-bold text-white mb-4">Delete Selected Media</h3>

            <p class="text-gray-300 mb-4">
                Are you sure you want to delete <span id="bulk-delete-count" class="font-semibold text-white">0</span> items?
            </p>

            <div class="bg-gray-900 rounded-lg p-4 mb-4 max-h-40 overflow-y-auto">
                <ul id="bulk-delete-list" class="text-sm text-gray-300 space-y-1">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>

            <!-- Delete files checkbox -->
            <div class="flex items-center mb-6">
                <input type="checkbox" id="bulk-delete-files" checked
                       class="w-4 h-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500 focus:ring-2">
                <label for="bulk-delete-files" class="ml-2 text-sm text-gray-300">
                    Delete files from disk
                </label>
            </div>

            {% if not deletion_sync_enabled %}
            <div class="bg-yellow-900/50 border border-yellow-600/50 rounded-lg p-3 mb-4">
                <p class="text-sm text-yellow-300">
                    <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Deletion sync is disabled. Only status-tracker records will be removed.
                </p>
            </div>
            {% endif %}

            <div class="flex justify-end space-x-3">
                <button onclick="hideBulkDeleteModal()"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="confirmBulkDelete()"
                        id="bulk-delete-confirm-btn"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
                    Delete All
                </button>
            </div>

            <!-- Loading state -->
            <div id="bulk-delete-loading" class="hidden absolute inset-0 bg-gray-800/90 flex items-center justify-center rounded-lg">
                <div class="text-center">
                    <svg class="animate-spin h-8 w-8 text-red-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-300">Deleting...</p>
                    <p id="bulk-delete-progress" class="text-sm text-gray-500 mt-1">0 / 0</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Filter functions
    function applyFilters() {
        const userFilter = document.getElementById('user-filter')?.value || '';
        const params = new URLSearchParams(window.location.search);

        if (userFilter) {
            params.set('user', userFilter);
        } else {
            params.delete('user');
        }

        window.location.search = params.toString();
    }

    {% if is_admin %}
    // Selection tracking
    let selectedItems = new Map(); // id -> title

    function toggleSelectAll() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.item-checkbox');

        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
            if (selectAll.checked) {
                selectedItems.set(cb.dataset.requestId, cb.dataset.title);
            }
        });

        if (!selectAll.checked) {
            selectedItems.clear();
        }

        updateSelectionCount();
    }

    function updateSelectionCount() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        selectedItems.clear();

        checkboxes.forEach(cb => {
            if (cb.checked) {
                selectedItems.set(cb.dataset.requestId, cb.dataset.title);
            }
        });

        const count = selectedItems.size;
        document.getElementById('selected-count').textContent = `(${count} selected)`;

        const bulkBtn = document.getElementById('bulk-delete-btn');
        if (count > 0) {
            bulkBtn.classList.remove('hidden');
            bulkBtn.textContent = `Delete Selected (${count})`;
        } else {
            bulkBtn.classList.add('hidden');
        }

        // Update select all checkbox state
        const selectAll = document.getElementById('select-all');
        if (checkboxes.length > 0) {
            selectAll.checked = count === checkboxes.length;
            selectAll.indeterminate = count > 0 && count < checkboxes.length;
        }
    }

    function showBulkDeleteModal() {
        const modal = document.getElementById('bulk-delete-modal');
        const list = document.getElementById('bulk-delete-list');
        const countEl = document.getElementById('bulk-delete-count');

        // Populate list
        list.innerHTML = '';
        selectedItems.forEach((title, id) => {
            const li = document.createElement('li');
            li.className = 'flex items-center';
            li.innerHTML = `
                <svg class="w-4 h-4 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                ${title}
            `;
            list.appendChild(li);
        });

        countEl.textContent = selectedItems.size;
        modal.classList.remove('hidden');
    }

    function hideBulkDeleteModal() {
        document.getElementById('bulk-delete-modal').classList.add('hidden');
        document.getElementById('bulk-delete-loading').classList.add('hidden');
    }

    async function confirmBulkDelete() {
        const deleteFiles = document.getElementById('bulk-delete-files').checked;
        const loading = document.getElementById('bulk-delete-loading');
        const progress = document.getElementById('bulk-delete-progress');

        loading.classList.remove('hidden');

        const ids = Array.from(selectedItems.keys()).map(id => parseInt(id));
        const total = ids.length;

        try {
            const token = localStorage.getItem('jellyfinToken') || '';

            const response = await fetch('/api/requests/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Jellyfin-Token': token,
                },
                body: JSON.stringify({
                    request_ids: ids,
                    delete_files: deleteFiles
                })
            });

            if (response.ok) {
                const results = await response.json();
                progress.textContent = `${results.length} / ${total} deleted`;

                // Refresh page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else if (response.status === 401) {
                alert('Authentication required. Please log in with your Jellyfin account.');
                hideBulkDeleteModal();
            } else if (response.status === 403) {
                alert('Admin privileges required to delete media.');
                hideBulkDeleteModal();
            } else {
                const error = await response.json();
                alert(`Bulk delete failed: ${error.detail || 'Unknown error'}`);
                hideBulkDeleteModal();
            }
        } catch (err) {
            console.error('Bulk delete error:', err);
            alert(`Bulk delete failed: ${err.message}`);
            hideBulkDeleteModal();
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideBulkDeleteModal();
            hideSyncModal();
        }
    });

    // Library Sync functions
    function showSyncModal() {
        const modal = document.getElementById('sync-modal');
        // Reset to initial state
        document.getElementById('sync-initial').classList.remove('hidden');
        document.getElementById('sync-loading').classList.add('hidden');
        document.getElementById('sync-results').classList.add('hidden');
        document.getElementById('sync-error').classList.add('hidden');
        modal.classList.remove('hidden');
    }

    function hideSyncModal() {
        document.getElementById('sync-modal').classList.add('hidden');
    }

    async function startSync() {
        // Show loading state
        document.getElementById('sync-initial').classList.add('hidden');
        document.getElementById('sync-loading').classList.remove('hidden');

        try {
            const token = localStorage.getItem('jellyfinToken') || '';

            const response = await fetch('/api/admin/sync/library', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Jellyfin-Token': token,
                }
            });

            if (response.ok) {
                const result = await response.json();

                // Update results
                document.getElementById('sync-total').textContent = result.total_scanned;
                document.getElementById('sync-added').textContent = result.added;
                document.getElementById('sync-updated').textContent = result.updated || 0;
                document.getElementById('sync-skipped').textContent = result.skipped;

                if (result.errors > 0) {
                    document.getElementById('sync-errors').textContent = result.errors;
                    document.getElementById('sync-errors-row').classList.remove('hidden');
                } else {
                    document.getElementById('sync-errors-row').classList.add('hidden');
                }

                // Show results
                document.getElementById('sync-loading').classList.add('hidden');
                document.getElementById('sync-results').classList.remove('hidden');

            } else if (response.status === 401) {
                showSyncError('Authentication required. Please log in with your Jellyfin account.');
            } else if (response.status === 403) {
                showSyncError('Admin privileges required to sync library.');
            } else {
                const error = await response.json();
                showSyncError(error.detail || 'Unknown error occurred');
            }
        } catch (err) {
            console.error('Sync error:', err);
            showSyncError(`Connection error: ${err.message}`);
        }
    }

    function showSyncError(message) {
        document.getElementById('sync-loading').classList.add('hidden');
        document.getElementById('sync-error-message').textContent = message;
        document.getElementById('sync-error').classList.remove('hidden');
    }

    function closeSyncAndRefresh() {
        hideSyncModal();
        window.location.reload();
    }
    {% endif %}
</script>
{% endblock %}
